<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>è£œåŠ©å“¡é‡é‡è¨ˆç®—ã‚²ãƒ¼ãƒ ï¼ˆè¨˜éŒ²ãƒ¢ãƒ¼ãƒ‰ï¼‰</title>
<style>
:root{
  --bg: #0b0712;
  --panel: #2e1229;
  --accent: #ffffff;
  --accent-2: #8b5cf6;
  --text: #f7f1e1;
  --muted: rgba(255,255,255,0.06);
}
*{box-sizing:border-box;}
body { font-family: 'Segoe UI'; text-align:center; background:#222; color:#fff; margin:0; padding:0; }
header{padding:14px 8px;}
h1{margin:6px 0;font-size:clamp(1.1rem,3.6vw,1.8rem);}
main{padding:8px 12px 100px;} /* ä¸‹ã‚¹ãƒšãƒ¼ã‚¹æ‹¡å¼µ */

/* ãƒ¢ãƒ¼ãƒ‰é¸æŠ */
#modeSelect{
  position:fixed; inset:0; background:rgba(0,0,0,0.7);
  display:flex; align-items:center; justify-content:center; z-index:2000;
}
.modeCard{
  background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.12));
  border: 1px solid rgba(255,255,255,0.03);
  padding:18px; border-radius:12px;
  width: 90vw; max-width: 600px;
  box-shadow:0 10px 40px rgba(0,0,0,0.7); text-align:center;
}
.modes{
  display:flex; flex-direction:column; gap:10px; margin-top:12px;
}
.modeBtn{
  background: #3b2a3a; color:var(--text); border:0;
  padding:18px 14px; border-radius:10px; cursor:pointer;
  font-weight:700; font-size: clamp(1rem,4vw,1.2rem);
}
.modeBtn:hover{
  background: linear-gradient(90deg,var(--accent), #ff9b4a);
  color:#1b0111; transform: translateY(-3px);
}
.modeBtn.active{outline:3px solid rgba(255,117,24,0.12);}

/* top bar */
#progress{position:fixed; top:10px; left:10px; font-weight:700;
  background:rgba(0,0,0,0.25); padding:6px 10px;border-radius:8px;}
#timer{position:fixed; top:10px; right:10px; font-weight:700;
  background:rgba(0,0,0,0.18); padding:6px 10px;border-radius:8px;color:var(--accent);}

/* target / bar / result */
#target{font-size:clamp(1.4rem,4vw,1.8rem); color:var(--accent); margin:12px 0;}
#bar{ font-size:clamp(1.4rem,3.5vw,1.3rem); margin:5px; }
#result{min-height:1.6em;}

/* plates */
.plates, .selected-area { display:flex; justify-content:center; gap:10px; flex-wrap:wrap; margin-inline:auto; max-width:900px; }
.plate, .selected-plate {
  border-radius:50%; width:clamp(56px,14vw,84px); height:clamp(56px,14vw,84px);
  display:flex; align-items:center; justify-content:center; cursor:pointer; font-weight:800;
  user-select:none; transition:transform 160ms ease, box-shadow 160ms;
  box-shadow: 0 6px 18px rgba(0,0,0,0.6); border: 2px solid rgba(255,255,255,0.03);
}
.plate:active{transform:scale(.96);}
.selected-plate { font-size:0.95rem; } /* ãƒ—ãƒ¬ãƒ¼ãƒˆå†…æ–‡å­—çµ±ä¸€ */

/* left/right placement animation */
@keyframes place-left { from { transform: translateY(-10px) scale(.9) } to { transform: translateX(-6px) translateY(0) scale(1) } }
@keyframes place-right { from { transform: translateY(-10px) scale(.9) } to { transform: translateX(6px) translateY(0) scale(1) } }

/* footer / action buttons */
.footerBtns{position:fixed; bottom:10px; left:10px; right:10px; display:flex; justify-content:space-between; gap:8px;}
.leftBtns{display:flex; gap:8px;}
.rightBtns{display:flex; gap:8px;}
.smallBtn{
  background: linear-gradient(180deg,#2b1b2f, #2f2236);
  color:var(--text); border:0; padding:8px 12px; border-radius:10px; cursor:pointer;
  box-shadow: 0 6px 16px rgba(0,0,0,0.6);
}
.smallBtn:hover{
  background:linear-gradient(90deg,var(--accent-2), var(--accent));
  color:#12030a;
}

/* next / big controls area */
.controls {
  margin: 12px 0;
  display: flex;
  justify-content: center; /* ä¸­å¤®æƒãˆ */
}
#nextBtn {
  position: static; /* fixed ã‚’ã‚„ã‚ã‚‹ */
  background: var(--accent);
  color: #1b0111;
  border: 0;
  padding: 12px 20px;
  border-radius: 12px;
  font-size: 1rem;
  cursor: pointer;
}
#nextBtn:disabled{background:#6b6b6b; cursor:not-allowed; color:#ddd;}

/* clear button */
#clearBtn{
  position: fixed;
  bottom:60px;
  left:50%;
  transform:translateX(-50%);
  padding:10px 16px; border-radius:10px; border:none;
  background: var(--accent-2); color:#fff; cursor:pointer; font-weight:700; z-index:1000;
}

/* result popup */
#scoreDisplay{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.7); z-index:3000;}
.scoreCard{background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.12)); padding:18px; border-radius:14px; width:min(760px,95%); text-align:left;}
.scoreCard h2{margin-top:0;}
.scoreRow{display:flex;gap:8px;flex-wrap:wrap;}
.closeBtn{background:var(--accent); color:#12030a; border:0; padding:8px 12px; border-radius:10px; cursor:pointer;}
.backIndex{background:#5b3b3b; color:var(--text); border:0; padding:8px 12px; border-radius:10px; cursor:pointer; margin-left:8px;}

/* responsive tweak */
@media (max-width:520px){
  .modeBtn{
    padding:12px 10px;
    font-size: clamp(0.9rem,4vw,1.1rem);
  }
}

</style>
</head>
<body>

<header>
  <h1>ğŸ‹ï¸â€â™‚ï¸ è£œåŠ©å“¡é‡é‡è¨ˆç®—ã‚²ãƒ¼ãƒ ï¼ˆè¨˜éŒ²ãƒ¢ãƒ¼ãƒ‰ï¼‰</h1>
</header>

<div id="progress">0 / 10</div>
<div id="timer">--</div>

<main>
  <div id="target">ç›®æ¨™é‡é‡: -- kg</div>

  <div class="plates" id="plates"></div>

    <div class="controls">
    <button id="nextBtn" disabled>æ¬¡ã¸</button>
  </div>

  <p id="bar">ç¾åœ¨ã®åˆè¨ˆ: 0kg</p>
  <p id="result"></p>

  <h3>ä½¿ç”¨ãƒ—ãƒ¬ãƒ¼ãƒˆ:</h3>
  <div class="selected-area" id="selectedArea"></div>
</main>

<!-- footer quick links -->
<div class="footerBtns">
  <div class="leftBtns">
    <button class="smallBtn" id="setumeiBtn" onclick="location.href='menyu.html'">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</button>
  </div>
  <div class="rightBtns">
    <button class="smallBtn" id="practiceBtn" onclick="location.href='index.html'">ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰</button>
  </div>
</div>

<!-- mode selector (overlay) -->
<div id="modeSelect">
  <div class="modeCard">
    <h2>ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¦ãã ã•ã„</h2>
    <div class="modes">
      <button class="modeBtn" data-mode="beginner"><h2>ã‚¹ã‚¿ãƒ¼ãƒˆ<br><small></small></h2></button>
    </div>
    <p style="margin-top:12px;font-size:0.9rem;color:#ddd">â€» é’ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆ20kgï¼‰ã¯ã€Œç›®æ¨™ãŒ75kgä»¥ä¸Šã€ã®å ´åˆã€**æœ€åˆã«ç½®ãã“ã¨ã¯ã§ãã¾ã›ã‚“**ï¼ˆ2æšç›®ä»¥é™ã¯OKï¼‰ã€‚</p>
  </div>
</div>

<!-- score popup -->
<div id="scoreDisplay">
  <div class="scoreCard" role="dialog" aria-modal="true">
    <h2>ğŸ“Š è¨˜éŒ²çµ‚äº†</h2>
    <div id="scoreContent"></div>
    <div style="margin-top:12px;text-align:right">
      <button class="backIndex" id="backIndex">é–‰ã˜ã‚‹ï¼ˆãƒ›ãƒ¼ãƒ ã¸ï¼‰</button>
      <button class="closeBtn" id="closeScore">ã‚‚ã†ä¸€åº¦ï¼ˆåŒã˜ãƒ¢ãƒ¼ãƒ‰ã§å†æŒ‘æˆ¦ï¼‰</button>
    </div>
  </div>
</div>

<script>
/* ========= åŠ¹æœéŸ³ï¼ˆå¤–éƒ¨URLï¼‰ =========
   ãƒ—ãƒ¬ãƒ¼ãƒˆã”ã¨ãƒ»å¤–ã™ãƒ»æ­£è§£ãƒ»ãƒŸã‚¹ã«å¯¾ã—ã¦URLã‚’ã‚»ãƒƒãƒˆã€‚
   ã“ã®ã¾ã¾å‹•ä½œã™ã‚‹å…¬é–‹URLã‚’åˆ©ç”¨ï¼ˆGoogle Actions soundsï¼‰ã€‚
*/
const SOUND = {
  25: "20.mp3",
  20: "20.mp3",
  15: "15.mp3",
  10: "10.mp3",
  5:  "5.mp3",
  "2.5_black":"2.5_black.mp3",
  "2.5_silver":"2.5_silver.mp3",
  "1.25":"1.25.mp3",
  remove: "remove.mp3",
  correct: "correct.mp3",
  miss: "miss.mp3"
};

function playSE(key){
  const url = SOUND[key];
  if(!url) return;
  const a = new Audio(url);
  a.volume = 0.55;
  a.play().catch(()=>{/* ignore autoplay errors */});
}

/* =========== ãƒ‡ãƒ¼ã‚¿ & UI è¦ç´  ============ */
const plateData = [
  { weight:25, color:'red' },
  { weight:20, color:'blue' },
  { weight:15, color:'yellow', textColor:'black' },
  { weight:10, color:'green' },
  { weight:5,  color:'white', textColor:'black' },
  { weight:2.5, color:'black' },
  { weight:2.5, color:'silver', label:'2.5(ã‚«ãƒ©ãƒ¼)' },
  { weight:1.25, color:'#7fae7f' }
];

const platesDiv = document.getElementById('plates');
const selectedArea = document.getElementById('selectedArea');
const targetEl = document.getElementById('target');
const barEl = document.getElementById('bar');
const resultEl = document.getElementById('result');
const nextBtn = document.getElementById('nextBtn');
const progressEl = document.getElementById('progress');
const timerEl = document.getElementById('timer');
const modeSelect = document.getElementById('modeSelect');
const modeBtns = document.querySelectorAll('.modeBtn');
const scoreDisplay = document.getElementById('scoreDisplay');
const scoreContent = document.getElementById('scoreContent');
const closeScore = document.getElementById('closeScore');
const backIndex = document.getElementById('backIndex');

/* =========== ã‚²ãƒ¼ãƒ çŠ¶æ…‹ ============ */
let mode = null;
let modeLabel = '';
let minW = 25, maxW = 350;
let timeLimit = 20;
let hideWeight = false;

let selected = [];
let targetWeight = 0;
let recordCount = 0;
let records = []; // { correct: bool, time: sec (float) }
let startTime = 0;
let timerInterval = null;
let roundsTotal = 10; // 10å•

/* =========== ãƒ¢ãƒ¼ãƒ‰é¸æŠå‡¦ç† ============ */
modeBtns.forEach(btn=>{
  btn.addEventListener('click', ()=>{
    modeBtns.forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const m = btn.dataset.mode;
    applyMode(m);
    modeSelect.style.display = 'none';
    startGame();
  });
});

function applyMode(m){
  mode = m;
  if(m==='beginner'){ minW=25; maxW=350; timeLimit=30; hideWeight=false; modeLabel='åˆå¿ƒè€…'; }
  else if(m==='intermediate'){ minW=120; maxW=210; timeLimit=20; hideWeight=false; modeLabel='ä¸­ç´šè€…'; }
  else if(m==='full'){ minW=210; maxW=350; timeLimit=20; hideWeight=false; modeLabel='ãƒ•ãƒ«ã‚®ã‚¢å‹¢'; }
  else { minW=25; maxW=350; timeLimit=10; hideWeight=true; modeLabel='ç¥'; }
  // reset progress UI
  recordCount = 0; records = []; updateProgress();
}

/* =========== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ============ */
function randTarget(min, max){
  const list = [];
  for(let w = min; w <= max + 0.0001; w += 2.5){
    // normalize to 2 decimal maybe
    list.push(Math.round(w * 100)/100);
  }
  return list[Math.floor(Math.random()*list.length)];
}

function updateProgress(){
  progressEl.textContent = `${recordCount} / ${roundsTotal}`;
}

/* =========== ã‚²ãƒ¼ãƒ ãƒ•ãƒ­ãƒ¼ ============ */
function startGame(){
  clearTimer();
  // pick target in mode range
  targetWeight = randTarget(minW, maxW);
  selected = [];
  nextBtn.disabled = true;
  resultEl.textContent = '';
  renderPlates();
  renderSelected(); // empty
  updateTotal();
  startTimer();
  startTime = Date.now();
}

function renderPlates(){
  platesDiv.innerHTML = '';
  plateData.forEach(p=>{
    const el = document.createElement('div');
    el.className = 'plate';
    el.textContent = p.label || p.weight;
    el.style.background = p.color;
    el.style.color = p.textColor || '#fff';

    // click handler
    el.addEventListener('click', ()=>{
      // Blue plate restriction:
      // if targetWeight >= 75 AND this would be the first plate placed -> do nothing
      if(p.weight === 20 && targetWeight >= 75 && selected.length === 0){
        // silently ignore (no error message, visual unchanged)
        return;
      }
      addPlate(p);
    });

    platesDiv.appendChild(el);
  });
}

function addPlate(p){
  // push a copy to avoid reference issues
  selected.push(Object.assign({}, p));
  // play sound for that plate (map weight/color to sound key)
  let key;
  if(p.weight === 2.5){
    key = (p.color === 'silver') ? '2.5_silver' : '2.5_black';
  } else {
    key = p.weight;
  }
  playSE(key);
  renderSelected();
  updateTotal();
}

/* å·¦å³äº¤äº’ã«ä¸¦ã¹ã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
function renderSelected(){
  selectedArea.innerHTML = '';
  selected.forEach((p, i) => {
    const el = document.createElement('div');
    el.className = 'selected-plate';
    el.textContent = p.label || p.weight;
    el.style.background = p.color;
    el.style.color = p.textColor || '#fff';
    // left/right class for animation
    el.classList.add((i % 2 === 0) ? 'placed-left' : 'placed-right');
    // click to remove
    el.addEventListener('click', ()=>{
      // remove and play remove SE
      selected.splice(i,1);
      playSE('remove');
      renderSelected();
      updateTotal();
    });
    selectedArea.appendChild(el);
  });
}

/* =========== åˆè¨ˆãƒ»åˆ¤å®š ============ */
function updateTotal(){
  const plateSum = selected.reduce((a,b)=>a+b.weight,0);
  const total = Math.round((20 + plateSum*2) * 100) / 100;

  // show or hide per mode (god hides)
  if(hideWeight) barEl.textContent = "ç¾åœ¨ã®åˆè¨ˆ: ???";
  else barEl.textContent = `ç¾åœ¨ã®åˆè¨ˆ: ${total.toFixed(2)} kg`;

  // progress color hint (optional)
  const diff = Math.abs(total - targetWeight);
  if (!hideWeight) {
    barEl.style.color = diff === 0 ? '#0f0' : (diff <= 5 ? '#ff0' : '#fff');
  } else {
    barEl.style.color = '#fff';
  }

  // last plate must be silver color (ã‚«ãƒ©ãƒ¼) and must be only at end; also no 1.25 after color
  const last = selected[selected.length - 1];
  const lastIsColor = last && last.color === 'silver';
  const colorInMiddle = selected.slice(0, -1).some(p => p.color === 'silver');
  let colorBefore125 = false;
  selected.forEach((p, idx) => {
    if(p.color === 'silver' && idx < selected.length - 1 && selected[idx + 1] && selected[idx+1].weight === 1.25){
      colorBefore125 = true;
    }
  });

  let resText = '';
  let correct = false;

  if(total === targetWeight && lastIsColor && !colorInMiddle && !colorBefore125){
    // correct
    resText = 'âœ… æ­£è§£ï¼ï¼ˆæœ€å¾Œã«ã‚«ãƒ©ãƒ¼ä»˜ãOKï¼‰';
    correct = true;
    playSE('correct');
    clearTimer(); // stop timer on correct
  } else if(total === targetWeight && !lastIsColor){
    resText = 'âš ï¸ æœ€å¾Œã«å¿…ãšã‚«ãƒ©ãƒ¼ã‚’ç½®ã„ã¦ãã ã•ã„';
  } else if(colorInMiddle){
    resText = 'âš ï¸ ã‚«ãƒ©ãƒ¼ã¯æœ€å¾Œã«1å›ã ã‘ç½®ã„ã¦ãã ã•ã„';
  } else if(colorBefore125){
    resText = 'âš ï¸ ã‚«ãƒ©ãƒ¼ã®å¾Œã«1.25kgã¯ç½®ã‘ã¾ã›ã‚“';
  } else if(total > targetWeight){
    resText = 'âŒ ã‚ªãƒ¼ãƒãƒ¼';
    // play miss sound but avoid repeating too much (we'll play once when this state entered)
    playSE('miss');
  } else {
    resText = '';
  }

  resultEl.textContent = resText;
  // next button enabled only when correct OR when time ran out (handled by timer)
  nextBtn.disabled = !correct && !window.__allowNextOnTimeout;
  // update target display
  targetEl.textContent = `ç›®æ¨™é‡é‡: ${targetWeight} kg`;
}

/* =========== ã‚¿ã‚¤ãƒãƒ¼ ============ */
function startTimer(){
  clearTimer();
  let remain = timeLimit;
  window.__allowNextOnTimeout = false; // flag set to true on timeout
  timerEl.textContent = `æ®‹ã‚Šæ™‚é–“: ${remain}ç§’`;

  timerInterval = setInterval(()=>{
    remain--;
    timerEl.textContent = `æ®‹ã‚Šæ™‚é–“: ${remain}ç§’`;
    if(remain <= 0){
      clearTimer();
      // timeout: mark as failed (if not yet correct)
      if(!resultEl.textContent.includes('âœ…')){
        resultEl.textContent = 'âŒ ã‚¿ã‚¤ãƒ ã‚ªãƒ¼ãƒãƒ¼';
        playSE('miss');
      }
      // allow Next after timeout
      window.__allowNextOnTimeout = true;
      nextBtn.disabled = false;
    }
  }, 1000);
}

function clearTimer(){
  if(timerInterval) {
    clearInterval(timerInterval);
    timerInterval = null;
  }
}

/* =========== è¨˜éŒ²ï¼ˆnextãƒœã‚¿ãƒ³ï¼‰ ============ */
nextBtn.addEventListener('click', ()=>{
  clearTimer();
  const elapsed = (Date.now() - startTime) / 1000;
  const wasCorrect = resultEl.textContent.includes('âœ…');
  records.push({ correct: wasCorrect, time: Math.round(elapsed*100)/100 });
  recordCount++;
  updateProgress();

  if(recordCount >= roundsTotal){
    showRecordResult();
  } else {
    // reset flag
    window.__allowNextOnTimeout = false;
    startGame();
  }
});

/* =========== çµæœè¡¨ç¤º ============ */
function showRecordResult(){
  // prepare popup content
  const correctCount = records.filter(r=>r.correct).length;
  const correctTimes = records.filter(r=>r.correct).map(r=>r.time.toFixed(2));
  const correctRate = ((correctCount / roundsTotal) * 100).toFixed(1);
  const avgSpeed = (correctTimes.length ? (correctTimes.reduce((a,b)=>a+parseFloat(b),0)/correctTimes.length) : 0).toFixed(2);

  let html = '';
  html += `<p><strong>ãƒ¢ãƒ¼ãƒ‰ï¼š</strong>${modeLabel}</p>`;
  html += `<p><strong>æ­£è§£å›æ•°ï¼š</strong>${correctCount} / ${roundsTotal}</p>`;
  html += `<p><strong>æ­£è§£ã¾ã§ã«ã‹ã‹ã£ãŸæ™‚é–“ï¼ˆæ­£è§£ã®ã¿ãƒ»ç§’ï¼‰:</strong> ${correctTimes.length ? correctTimes.join(', ') : 'â€”'}</p>`;
  html += `<p><strong>æ­£è§£ç‡ï¼š</strong>${correctRate}%</p>`;
  html += `<p><strong>å¹³å‡ã‚¿ã‚¤ãƒ ï¼š</strong>${avgSpeed} ç§’</p>`;
  html += `<hr />`;
  html += `<p style="font-size:0.9rem;color:#ddd">é–‰ã˜ã‚‹ï¼ˆãƒ›ãƒ¼ãƒ ã¸ï¼‰ã¯ index.html ã«æˆ»ã‚Šã¾ã™ã€‚ã‚‚ã†ä¸€åº¦ã¯åŒã˜ãƒ¢ãƒ¼ãƒ‰ã§å†æŒ‘æˆ¦ã—ã¾ã™ã€‚</p>`;

  scoreContent.innerHTML = html;
  scoreDisplay.style.display = 'flex';
}

/* popup buttons */
closeScore.addEventListener('click', ()=>{
  // close popup and restart in same mode
  scoreDisplay.style.display = 'none';
  // reset and start (same mode)
  recordCount = 0;
  records = [];
  updateProgress();
  startGame();
});
backIndex.addEventListener('click', ()=>{
  // go to index
  location.href = 'index.html';
});

/* =========== åˆæœŸåŒ–: éš ã‚ŒãŸãƒ¢ãƒ¼ãƒ‰ãƒ”ãƒƒã‚¯ã‚’è¡¨ç¤ºï¼ˆUIã®ãƒ¢ãƒ¼ãƒ‰é¸æŠã§é–‹å§‹ï¼‰ ============ */
// show mode select overlay (already visible by default)
updateProgress();
// (If you prefer auto-start in a default mode, call applyMode('beginner') and modeSelect.style.display='none' and startGame()).
</script>
</body>
</html>

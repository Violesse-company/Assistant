<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>補助員重量計算ゲーム（記録モード）</title>
<style>
:root{
  --bg: #0b0712;        /* とても暗い紫/黒 */
  --panel: #2e1229;     /* 深めの紫パネル */
  --accent: #ff7518;    /* かぼちゃオレンジ（アクセント） */
  --accent-2: #8b5cf6;  /* 補助の紫（強調時） */
  --text: #f7f1e1;      /* くすんだクリーム（読みやすい） */
  --muted: rgba(255,255,255,0.06);
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family: "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
  background:var(--bg);
  color:var(--text);
  text-align:center;
}
header{padding:14px 8px}
h1{margin:6px 0;font-size:clamp(1.1rem,3.6vw,1.8rem)}
main{padding:8px 12px 80px}
/* mode selector overlay */
#modeSelect{
  position:fixed; inset:0; background:rgba(4,4,8,0.7);
  display:flex; align-items:center; justify-content:center; z-index:2000;
}
.modeCard{
  background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.12));
  border: 1px solid rgba(255,255,255,0.03);
  padding:18px; border-radius:12px; width:min(640px,92%);
  box-shadow:0 10px 40px rgba(0,0,0,0.7); text-align:center;
}
.modes{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:12px}
.modeBtn{
  background: #3b2a3a; /* 暗めの紫寄り */
  color:var(--text); border:0; padding:10px 14px; border-radius:10px; cursor:pointer;
  min-width:120px; font-weight:700;
  box-shadow: 0 6px 14px rgba(0,0,0,0.6);
}
.modeBtn:hover{
  background: linear-gradient(90deg,var(--accent), #ff9b4a);
  color:#1b0111;
  transform: translateY(-3px);
}
.modeBtn.active{outline:3px solid rgba(255,117,24,0.12)}
/* top bar */
#progress{position:fixed; top:10px; left:10px; font-weight:700;
  background:rgba(0,0,0,0.25); padding:6px 10px;border-radius:8px}
#timer{position:fixed; top:10px; right:10px; font-weight:700;
  background:rgba(0,0,0,0.18); padding:6px 10px;border-radius:8px;color:var(--accent)}
/* target / bar / result */
#target{font-size:clamp(1rem,3vw,1.3rem); color:var(--accent); margin:12px 0}
#bar{margin:8px 0; font-weight:700}
#result{min-height:1.6em}
/* plates */
.plates, .selected-area { display:flex; justify-content:center; gap:10px; flex-wrap:wrap; margin-inline:auto; max-width:900px; }
.plate, .selected-plate {
  border-radius:50%; width:clamp(56px,14vw,84px); height:clamp(56px,14vw,84px);
  display:flex; align-items:center; justify-content:center; cursor:pointer; font-weight:800;
  user-select:none; transition:transform 160ms ease, box-shadow 160ms;
  box-shadow: 0 6px 18px rgba(0,0,0,0.6);
  border: 2px solid rgba(255,255,255,0.03);
}
.plate:active{transform:scale(.96)}
.selected-plate { width:clamp(46px,12vw,68px); height:clamp(46px,12vw,68px); font-size:0.95rem; }
/* left/right placement animation */
.placed-left{ transform-origin:center left; animation:place-left 280ms ease forwards; }
.placed-right{ transform-origin:center right; animation:place-right 280ms ease forwards; }
@keyframes place-left { from { transform: translateY(-10px) scale(.9) } to { transform: translateX(-6px) translateY(0) scale(1) } }
@keyframes place-right { from { transform: translateY(-10px) scale(.9) } to { transform: translateX(6px) translateY(0) scale(1) } }

/* footer action buttons */
.footerBtns{position:fixed; bottom:10px; left:10px; right:10px; display:flex; justify-content:space-between; gap:8px}
.leftBtns{display:flex; gap:8px}
.rightBtns{display:flex; gap:8px}
.smallBtn{
  background: linear-gradient(180deg,#2b1b2f, #2f2236);
  color:var(--text); border:0; padding:8px 12px; border-radius:10px; cursor:pointer;
  box-shadow: 0 6px 16px rgba(0,0,0,0.6);
}
.smallBtn:hover{
  background:linear-gradient(90deg,var(--accent-2), var(--accent));
  color:#12030a;
}

/* next / big controls area */
.controls{margin:14px 0}
#nextBtn{background:var(--accent); color:#1b0111; border:0; padding:12px 20px; border-radius:12px; font-size:1rem; cursor:pointer}
#nextBtn:disabled{background:#6b6b6b; cursor:not-allowed; color:#ddd}

/* result popup */
#scoreDisplay{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.7); z-index:3000}
.scoreCard{background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.12)); padding:18px; border-radius:14px; width:min(760px,95%); text-align:left}
.scoreCard h2{margin-top:0}
.scoreRow{display:flex;gap:8px;flex-wrap:wrap}
.closeBtn{background:var(--accent); color:#12030a; border:0; padding:8px 12px; border-radius:10px; cursor:pointer}
.backIndex{background:#5b3b3b; color:var(--text); border:0; padding:8px 12px; border-radius:10px; cursor:pointer; margin-left:8px}

/* responsive tweak */
@media (max-width:520px){
  .modeBtn{min-width:44%; padding:10px}
  .plates, .selected-area{gap:8px}
}

</style>
</head>
<body>

<header>
  <h1>🏋️‍♂️ 補助員重量計算ゲーム（記録モード）</h1>
</header>

<div id="progress">0 / 10</div>
<div id="timer">--</div>

<main>
  <div id="target">目標重量: -- kg</div>

  <div class="plates" id="plates"></div>

  <p id="bar">現在の合計: 0kg</p>
  <p id="result"></p>

  <h3>使用プレート:</h3>
  <div class="selected-area" id="selectedArea"></div>

  <div class="controls">
    <button id="nextBtn" disabled>次へ</button>
  </div>
</main>

<!-- footer quick links -->
<div class="footerBtns">
  <div class="leftBtns">
    <button class="smallBtn" id="setumeiBtn" onclick="location.href='setumei.html'">説明モード</button>
    <button class="smallBtn" id="rankingBtn" onclick="location.href='ranking.html'">ランキング</button>
  </div>
  <div class="rightBtns">
    <button class="smallBtn" id="practiceBtn" onclick="location.href='index.html'">練習モード</button>
    <button class="smallBtn" id="feedbackBtn" onclick="location.href='fiidobaItuku.html'">フィードバック</button>
  </div>
</div>

<!-- mode selector (overlay) -->
<div id="modeSelect">
  <div class="modeCard">
    <h2>難易度を選んでください</h2>
    <p>モードごとに出題範囲と制限時間が変わります。</p>
    <div class="modes">
      <button class="modeBtn" data-mode="beginner">初心者<br><small>25〜120kg / 30秒</small></button>
      <button class="modeBtn" data-mode="intermediate">中級者<br><small>120〜210kg / 20秒</small></button>
      <button class="modeBtn" data-mode="full">フルギア勢<br><small>210〜350kg / 20秒</small></button>
      <button class="modeBtn" data-mode="god">神<br><small>25〜350kg / 10秒（合計非表示）</small></button>
    </div>
    <p style="margin-top:12px;font-size:0.9rem;color:#ddd">※ 青プレート（20kg）は「目標が75kg以上」の場合、**最初に置くことはできません**（2枚目以降はOK）。</p>
  </div>
</div>

<!-- score popup -->
<div id="scoreDisplay">
  <div class="scoreCard" role="dialog" aria-modal="true">
    <h2>📊 記録終了</h2>
    <div id="scoreContent"></div>
    <div style="margin-top:12px;text-align:right">
      <button class="backIndex" id="backIndex">閉じる（ホームへ）</button>
      <button class="closeBtn" id="closeScore">もう一度（同じモードで再挑戦）</button>
    </div>
  </div>
</div>

<script>
/* ========= 効果音（外部URL） =========
   プレートごと・外す・正解・ミスに対してURLをセット。
   このまま動作する公開URLを利用（Google Actions sounds）。
*/
const SOUND = {
  25: "20.mp3",
  20: "20.mp3",
  15: "15.mp3",
  10: "10.mp3",
  5:  "5.mp3",
  "2.5_black":"2.5_black.mp3",
  "2.5_silver":"2.5_silver.mp3",
  "1.25":"1.25.mp3",
  remove: "remove.mp3",
  correct: "correct.mp3",
  miss: "miss.mp3"
};

function playSE(key){
  const url = SOUND[key];
  if(!url) return;
  const a = new Audio(url);
  a.volume = 0.55;
  a.play().catch(()=>{/* ignore autoplay errors */});
}

/* =========== データ & UI 要素 ============ */
const plateData = [
  { weight:25, color:'red' },
  { weight:20, color:'blue' },
  { weight:15, color:'yellow', textColor:'black' },
  { weight:10, color:'green' },
  { weight:5,  color:'white', textColor:'black' },
  { weight:2.5, color:'black' },
  { weight:2.5, color:'silver', label:'2.5(カラー)' },
  { weight:1.25, color:'#7fae7f' }
];

const platesDiv = document.getElementById('plates');
const selectedArea = document.getElementById('selectedArea');
const targetEl = document.getElementById('target');
const barEl = document.getElementById('bar');
const resultEl = document.getElementById('result');
const nextBtn = document.getElementById('nextBtn');
const progressEl = document.getElementById('progress');
const timerEl = document.getElementById('timer');
const modeSelect = document.getElementById('modeSelect');
const modeBtns = document.querySelectorAll('.modeBtn');
const scoreDisplay = document.getElementById('scoreDisplay');
const scoreContent = document.getElementById('scoreContent');
const closeScore = document.getElementById('closeScore');
const backIndex = document.getElementById('backIndex');

/* =========== ゲーム状態 ============ */
let mode = null;
let modeLabel = '';
let minW = 25, maxW = 350;
let timeLimit = 20;
let hideWeight = false;

let selected = [];
let targetWeight = 0;
let recordCount = 0;
let records = []; // { correct: bool, time: sec (float) }
let startTime = 0;
let timerInterval = null;
let roundsTotal = 10; // 10問

/* =========== モード選択処理 ============ */
modeBtns.forEach(btn=>{
  btn.addEventListener('click', ()=>{
    modeBtns.forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const m = btn.dataset.mode;
    applyMode(m);
    modeSelect.style.display = 'none';
    startGame();
  });
});

function applyMode(m){
  mode = m;
  if(m==='beginner'){ minW=25; maxW=120; timeLimit=30; hideWeight=false; modeLabel='初心者'; }
  else if(m==='intermediate'){ minW=120; maxW=210; timeLimit=20; hideWeight=false; modeLabel='中級者'; }
  else if(m==='full'){ minW=210; maxW=350; timeLimit=20; hideWeight=false; modeLabel='フルギア勢'; }
  else { minW=25; maxW=350; timeLimit=10; hideWeight=true; modeLabel='神'; }
  // reset progress UI
  recordCount = 0; records = []; updateProgress();
}

/* =========== ユーティリティ ============ */
function randTarget(min, max){
  const list = [];
  for(let w = min; w <= max + 0.0001; w += 2.5){
    // normalize to 2 decimal maybe
    list.push(Math.round(w * 100)/100);
  }
  return list[Math.floor(Math.random()*list.length)];
}

function updateProgress(){
  progressEl.textContent = `${recordCount} / ${roundsTotal}`;
}

/* =========== ゲームフロー ============ */
function startGame(){
  clearTimer();
  // pick target in mode range
  targetWeight = randTarget(minW, maxW);
  selected = [];
  nextBtn.disabled = true;
  resultEl.textContent = '';
  renderPlates();
  renderSelected(); // empty
  updateTotal();
  startTimer();
  startTime = Date.now();
}

function renderPlates(){
  platesDiv.innerHTML = '';
  plateData.forEach(p=>{
    const el = document.createElement('div');
    el.className = 'plate';
    el.textContent = p.label || p.weight;
    el.style.background = p.color;
    el.style.color = p.textColor || '#fff';

    // click handler
    el.addEventListener('click', ()=>{
      // Blue plate restriction:
      // if targetWeight >= 75 AND this would be the first plate placed -> do nothing
      if(p.weight === 20 && targetWeight >= 75 && selected.length === 0){
        // silently ignore (no error message, visual unchanged)
        return;
      }
      addPlate(p);
    });

    platesDiv.appendChild(el);
  });
}

function addPlate(p){
  // push a copy to avoid reference issues
  selected.push(Object.assign({}, p));
  // play sound for that plate (map weight/color to sound key)
  let key;
  if(p.weight === 2.5){
    key = (p.color === 'silver') ? '2.5_silver' : '2.5_black';
  } else {
    key = p.weight;
  }
  playSE(key);
  renderSelected();
  updateTotal();
}

/* 左右交互に並べるアニメーション */
function renderSelected(){
  selectedArea.innerHTML = '';
  selected.forEach((p, i) => {
    const el = document.createElement('div');
    el.className = 'selected-plate';
    el.textContent = p.label || p.weight;
    el.style.background = p.color;
    el.style.color = p.textColor || '#fff';
    // left/right class for animation
    el.classList.add((i % 2 === 0) ? 'placed-left' : 'placed-right');
    // click to remove
    el.addEventListener('click', ()=>{
      // remove and play remove SE
      selected.splice(i,1);
      playSE('remove');
      renderSelected();
      updateTotal();
    });
    selectedArea.appendChild(el);
  });
}

/* =========== 合計・判定 ============ */
function updateTotal(){
  const plateSum = selected.reduce((a,b)=>a+b.weight,0);
  const total = Math.round((20 + plateSum*2) * 100) / 100;

  // show or hide per mode (god hides)
  if(hideWeight) barEl.textContent = "現在の合計: ???";
  else barEl.textContent = `現在の合計: ${total.toFixed(2)} kg`;

  // progress color hint (optional)
  const diff = Math.abs(total - targetWeight);
  if (!hideWeight) {
    barEl.style.color = diff === 0 ? '#0f0' : (diff <= 5 ? '#ff0' : '#fff');
  } else {
    barEl.style.color = '#fff';
  }

  // last plate must be silver color (カラー) and must be only at end; also no 1.25 after color
  const last = selected[selected.length - 1];
  const lastIsColor = last && last.color === 'silver';
  const colorInMiddle = selected.slice(0, -1).some(p => p.color === 'silver');
  let colorBefore125 = false;
  selected.forEach((p, idx) => {
    if(p.color === 'silver' && idx < selected.length - 1 && selected[idx + 1] && selected[idx+1].weight === 1.25){
      colorBefore125 = true;
    }
  });

  let resText = '';
  let correct = false;

  if(total === targetWeight && lastIsColor && !colorInMiddle && !colorBefore125){
    // correct
    resText = '✅ 正解！（最後にカラー付きOK）';
    correct = true;
    playSE('correct');
    clearTimer(); // stop timer on correct
  } else if(total === targetWeight && !lastIsColor){
    resText = '⚠️ 最後に必ずカラーを置いてください';
  } else if(colorInMiddle){
    resText = '⚠️ カラーは最後に1回だけ置いてください';
  } else if(colorBefore125){
    resText = '⚠️ カラーの後に1.25kgは置けません';
  } else if(total > targetWeight){
    resText = '❌ オーバー';
    // play miss sound but avoid repeating too much (we'll play once when this state entered)
    playSE('miss');
  } else {
    resText = '';
  }

  resultEl.textContent = resText;
  // next button enabled only when correct OR when time ran out (handled by timer)
  nextBtn.disabled = !correct && !window.__allowNextOnTimeout;
  // update target display
  targetEl.textContent = `目標重量: ${targetWeight} kg`;
}

/* =========== タイマー ============ */
function startTimer(){
  clearTimer();
  let remain = timeLimit;
  window.__allowNextOnTimeout = false; // flag set to true on timeout
  timerEl.textContent = `残り時間: ${remain}秒`;

  timerInterval = setInterval(()=>{
    remain--;
    timerEl.textContent = `残り時間: ${remain}秒`;
    if(remain <= 0){
      clearTimer();
      // timeout: mark as failed (if not yet correct)
      if(!resultEl.textContent.includes('✅')){
        resultEl.textContent = '❌ タイムオーバー';
        playSE('miss');
      }
      // allow Next after timeout
      window.__allowNextOnTimeout = true;
      nextBtn.disabled = false;
    }
  }, 1000);
}

function clearTimer(){
  if(timerInterval) {
    clearInterval(timerInterval);
    timerInterval = null;
  }
}

/* =========== 記録（nextボタン） ============ */
nextBtn.addEventListener('click', ()=>{
  clearTimer();
  const elapsed = (Date.now() - startTime) / 1000;
  const wasCorrect = resultEl.textContent.includes('✅');
  records.push({ correct: wasCorrect, time: Math.round(elapsed*100)/100 });
  recordCount++;
  updateProgress();

  if(recordCount >= roundsTotal){
    showRecordResult();
  } else {
    // reset flag
    window.__allowNextOnTimeout = false;
    startGame();
  }
});

/* =========== 結果表示 ============ */
function showRecordResult(){
  // prepare popup content
  const correctCount = records.filter(r=>r.correct).length;
  const correctTimes = records.filter(r=>r.correct).map(r=>r.time.toFixed(2));
  const correctRate = ((correctCount / roundsTotal) * 100).toFixed(1);
  const avgSpeed = (correctTimes.length ? (correctTimes.reduce((a,b)=>a+parseFloat(b),0)/correctTimes.length) : 0).toFixed(2);

  let html = '';
  html += `<p><strong>モード：</strong>${modeLabel}</p>`;
  html += `<p><strong>正解回数：</strong>${correctCount} / ${roundsTotal}</p>`;
  html += `<p><strong>正解までにかかった時間（正解のみ・秒）:</strong> ${correctTimes.length ? correctTimes.join(', ') : '—'}</p>`;
  html += `<p><strong>正解率：</strong>${correctRate}%</p>`;
  html += `<p><strong>平均タイム：</strong>${avgSpeed} 秒</p>`;
  html += `<hr />`;
  html += `<p style="font-size:0.9rem;color:#ddd">閉じる（ホームへ）は index.html に戻ります。もう一度は同じモードで再挑戦します。</p>`;

  scoreContent.innerHTML = html;
  scoreDisplay.style.display = 'flex';
}

/* popup buttons */
closeScore.addEventListener('click', ()=>{
  // close popup and restart in same mode
  scoreDisplay.style.display = 'none';
  // reset and start (same mode)
  recordCount = 0;
  records = [];
  updateProgress();
  startGame();
});
backIndex.addEventListener('click', ()=>{
  // go to index
  location.href = 'index.html';
});

/* =========== 初期化: 隠れたモードピックを表示（UIのモード選択で開始） ============ */
// show mode select overlay (already visible by default)
updateProgress();
// (If you prefer auto-start in a default mode, call applyMode('beginner') and modeSelect.style.display='none' and startGame()).
</script>
</body>
</html>
